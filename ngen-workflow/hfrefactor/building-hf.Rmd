---
title: "Building HF"
output: html_document
date: "2026-02-06"
---

I'm following this tutorial: <https://noaa-owp.github.io/hydrofabric/articles/devcon2024-tutorial.html>, but using the libraries published here: <https://github.com/lynker-spatial/>

Data was downloaded:

-   <https://proxy.lynker-spatial.com/gridded>, FDR and FAC
-   <https://proxy.lynker-spatial.com/hydrofabric/v2.3/superconus/cn/>, 01 data
- pois obtained from: https://proxy.lynker-spatial.com/hydrofabric/v3.0/superconus/reference/cn/pois/vpuid%3D01/

Packages were installed like this: 
- GDAL must be installed with Spatialite support. I did this on mac like this: 
- brew install gdal libspatialite sqlite 
- check that it's working as expected: gdalinfo --formats \| grep -i spatial 
- install.packages("sf", type = "source") # make sure SF is install with spatialite support
- remotes::install_github("[lynker-spatial/hfutils\@f74e9a41beaddf539c9420fc0f01ed1dc18820a2](mailto:lynker-spatial/hfutils@f74e9a41beaddf539c9420fc0f01ed1dc18820a2){.email}") \# HEAD was failing - remotes::install_github("lynker-spatial/hfrefactor") 
- whitebox::install_whitebox()



echo 'DYLD_LIBRARY_PATH=/usr/local/lib:/usr/local/Cellar/libspatialite/5.1.0_3/lib:$DYLD_LIBRARY_PATH' >> ~/.Renviron

echo 'GDAL_DRIVER_PATH=/usr/local/lib' >> ~/.Renviron



```{r}
Sys.setenv(GDAL_SQLITE_LOAD_EXTENSIONS = "YES")
```

```{r}
Sys.getenv("DYLD_LIBRARY_PATH")
Sys.getenv("GDAL_SQLITE_LOAD_EXTENSIONS")
```

```{r}
library(sf)
library(hfrefactor)
```

```{r}
sf::sf_extSoftVersion()  # Check versions first
```

```{r}
Sys.setenv(CPL_DEBUG = "ON")
```

```{r}
gpkg   <- "vpu_01/reference_hydrofabric.gpkg"   # must contain flowpaths, divides, (optionally) events
fac    <- "vpu_01/01a_fac.tif"                  # optional flow accumulation raster
fdr    <- "vpu_01/01a_fdr.tif"                  # optional flow direction raster
outfile <- "vpu_01_out/refactored_reference_hydrofabric.gpkg"
```

```{r}
refactor(
  gpkg      = gpkg,
  fac       = fac,
  fdr       = fdr,
  outfile   = outfile,
  split_flines_meters         = 10000,
  collapse_flines_meters      = 1000,
  collapse_flines_main_meters = 1000,
  simplify_tolerance_m        = 40
)
```
